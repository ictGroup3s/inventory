<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="statsmapper">

    <!-- 일별 매출 (최근 7일) -->
    <select id="getDailySales" resultType="map">
        SELECT 
            TO_CHAR(o.order_date, 'MM-DD') as label,
            NVL(SUM(od.item_price * od.item_cnt), 0) as total
        FROM orders o
        LEFT JOIN order_detail od ON o.order_no = od.order_no
        WHERE o.order_date >= TRUNC(SYSDATE) - 6
          AND o.order_status != '취소'
        GROUP BY TO_CHAR(o.order_date, 'MM-DD'), TRUNC(o.order_date)
        ORDER BY TRUNC(o.order_date)
    </select>

    <!-- 카테고리별 매출 -->
    <select id="getCategorySales" resultType="map">
        SELECT 
            c.cate_name as label,
            NVL(SUM(od.item_price * od.item_cnt), 0) as total
        FROM order_detail od
        JOIN product p ON od.item_no = p.item_no
        JOIN cate c ON p.cate_no = c.cate_no
        JOIN orders o ON od.order_no = o.order_no
        WHERE o.order_status != '취소'
        GROUP BY c.cate_name
        ORDER BY total DESC
    </select>

    <!-- 수입/지출 (최근 7일) -->
    <select id="getIncomeExpense" resultType="map">
        SELECT 
            TO_CHAR(base_date, 'MM-DD') as label,
            NVL(income, 0) as income,
            NVL(expense, 0) as expense
        FROM (
            SELECT TRUNC(SYSDATE) - LEVEL + 1 as base_date
            FROM dual
            CONNECT BY LEVEL &lt;= 7
        ) dates
        LEFT JOIN (
            SELECT TRUNC(o.order_date) as sale_date,
                   SUM(od.item_price * od.item_cnt) as income
            FROM orders o
            JOIN order_detail od ON o.order_no = od.order_no
            WHERE o.order_status != '취소'
            GROUP BY TRUNC(o.order_date)
        ) sales ON dates.base_date = sales.sale_date
        LEFT JOIN (
            SELECT TRUNC(s.in_date) as stock_date,
                   SUM(s.stock_in * p.origin_p) as expense
            FROM stock s
            JOIN product p ON s.item_no = p.item_no
            WHERE s.stock_in > 0
            GROUP BY TRUNC(s.in_date)
        ) stocks ON dates.base_date = stocks.stock_date
        ORDER BY base_date
    </select>

    <!-- 일별 주문건수 (최근 7일) -->
    <select id="getDailyOrders" resultType="map">
        SELECT 
            TO_CHAR(base_date, 'MM-DD') as label,
            NVL(order_cnt, 0) as orders
        FROM (
            SELECT TRUNC(SYSDATE) - LEVEL + 1 as base_date
            FROM dual
            CONNECT BY LEVEL &lt;= 7
        ) dates
        LEFT JOIN (
            SELECT TRUNC(order_date) as order_date,
                   COUNT(*) as order_cnt
            FROM orders
            WHERE order_status != '취소'
            GROUP BY TRUNC(order_date)
        ) o ON dates.base_date = o.order_date
        ORDER BY base_date
    </select>
    
    <!-- 일별 통계 집계 (전날 데이터) -->
	<insert id="insertDailyStats">
	    INSERT INTO stats (
	        stats_id,
	        stats_date,
	        total_order,
	        total_sales,
	        cancel_cnt,
	        return_cnt,
	        total_price,
	        margin,
	        total_discount
	    )
	    SELECT 
	        stats_seq.NEXTVAL,
	        stats_date,
	        total_order,
	        total_sales,
	        cancel_cnt,
	        return_cnt,
	        total_price,
	        margin,
	        total_discount
	    FROM (
	        SELECT 
	            TRUNC(SYSDATE - 1) as stats_date,
	            COUNT(DISTINCT o.order_no) as total_order,
	            NVL(SUM(od.item_cnt), 0) as total_sales,
	            NVL((SELECT COUNT(*) FROM cr WHERE type = '취소' AND TRUNC(re_date) = TRUNC(SYSDATE - 1)), 0) as cancel_cnt,
	            NVL((SELECT SUM(return_cnt) FROM cr WHERE type = '반품' AND TRUNC(re_date) = TRUNC(SYSDATE - 1)), 0) as return_cnt,
	            NVL(SUM(od.item_price * od.item_cnt), 0) as total_price,
	            CASE 
	                WHEN SUM(od.item_price * od.item_cnt) > 0 
	                THEN ROUND(
	                    (SUM(od.item_price * od.item_cnt) - SUM(p.origin_p * od.item_cnt)) 
	                    / SUM(od.item_price * od.item_cnt) * 100, 2
	                )
	                ELSE 0 
	            END as margin,
	            0 as total_discount
	        FROM orders o
	        LEFT JOIN order_detail od ON o.order_no = od.order_no
	        LEFT JOIN product p ON od.item_no = p.item_no
	        WHERE TRUNC(o.order_date) = TRUNC(SYSDATE - 1)
	          AND o.order_status != '취소'
	        GROUP BY TRUNC(SYSDATE - 1)
	    ) sub
	    WHERE sub.total_order > 0
	</insert>

</mapper>