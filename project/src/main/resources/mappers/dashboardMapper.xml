<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dashboardmapper">

    <!-- ÎåÄÏãúÎ≥¥Îìú ÏöîÏïΩ (Ïπ¥Îìú 4Í∞ú) -->
    <select id="getSummary" resultType="map">
	    SELECT
	        -- üî• Ï∑®ÏÜå/Î∞òÌíà Í±¥Ïàò (Ï≤´ Î≤àÏß∏ Ïπ¥Îìú)
	        (SELECT COUNT(*) FROM orders 
	         WHERE order_status IN ('Ï∑®ÏÜå', 'Î∞òÌíà')) as cancel_return_count,
	        
	        -- Ïò§Îäò Ï£ºÎ¨∏Í±¥Ïàò
	        (SELECT COUNT(*) FROM orders 
	         WHERE TRUNC(order_date) = TRUNC(SYSDATE) 
	         AND order_status != 'Ï∑®ÏÜå') as today_orders,
	        
	        -- Ïò§Îäò Îß§Ï∂ú
	        (SELECT NVL(SUM(od.item_price * od.item_cnt), 0) 
	         FROM orders o
	         JOIN order_detail od ON o.order_no = od.order_no
	         WHERE TRUNC(o.order_date) = TRUNC(SYSDATE)
	         AND o.order_status != 'Ï∑®ÏÜå') as today_sales,
	        
	        -- Ïù¥Î≤àÎã¨ Îß§Ï∂ú
	        (SELECT NVL(SUM(od.item_price * od.item_cnt), 0)
	         FROM orders o
	         JOIN order_detail od ON o.order_no = od.order_no
	         WHERE TO_CHAR(o.order_date, 'YYYY-MM') = TO_CHAR(SYSDATE, 'YYYY-MM')
	         AND o.order_status != 'Ï∑®ÏÜå') as month_sales,
	        
	        -- Ï¥ù Ï£ºÎ¨∏Í±¥Ïàò
	        (SELECT COUNT(*) FROM orders WHERE order_status != 'Ï∑®ÏÜå') as total_orders,
	        
	        -- Ï¥ù Îß§Ï∂ú
	        (SELECT NVL(SUM(od.item_price * od.item_cnt), 0)
	         FROM orders o
	         JOIN order_detail od ON o.order_no = od.order_no
	         WHERE o.order_status != 'Ï∑®ÏÜå') as total_sales
	
	    FROM dual
	</select>


    <!-- Ï£ºÎ¨∏ Ï†ÑÏ≤¥ (Îß§Ïùº ÏûêÏ†ï ÏûêÎèô Ï¥àÍ∏∞Ìôî) -->
	<!-- ÎÇ†ÏßúÎ≥Ñ Ï£ºÎ¨∏ Ï°∞Ìöå (Ï£ºÎ¨∏Î≤àÌò∏Î≥Ñ Í∑∏Î£πÌïë) -->
	<select id="getRecentOrders" resultType="map" parameterType="String">
	    SELECT
	        o.order_no,
	        o.order_name as customer_name,
	        (SELECT p.item_name 
	         FROM order_detail od2 
	         JOIN product p ON od2.item_no = p.item_no 
	         WHERE od2.order_no = o.order_no 
	         AND ROWNUM = 1) as item_name,
	        (SELECT COUNT(*) FROM order_detail od3 WHERE od3.order_no = o.order_no) as item_count,
	        SUM(od.item_cnt) as qty,
	        SUM(od.item_price * od.item_cnt) as amount,
	        TO_CHAR(o.order_date, 'MM-DD HH24:MI') as order_date
	    FROM orders o
	    JOIN order_detail od ON o.order_no = od.order_no
	    WHERE o.order_status != 'Ï∑®ÏÜå'
	      AND TRUNC(o.order_date) =
	        <choose>
	            <when test="_parameter != null and _parameter != ''">
	                TO_DATE(#{_parameter}, 'YYYY-MM-DD')
	            </when>
	            <otherwise>
	                TRUNC(SYSDATE)
	            </otherwise>
	        </choose>
	    GROUP BY o.order_no, o.order_name, o.order_date
	    ORDER BY o.order_date DESC
	</select>
	
    <!-- ÏùºÎ≥Ñ Îß§Ï∂ú (ÏµúÍ∑º 7Ïùº) -->
    <select id="getDailySales" resultType="map">
        SELECT 
            TO_CHAR(base_date, 'MM-DD') as label,
            NVL(sales, 0) as sales,
            NVL(expense, 0) as expense
        FROM (
            SELECT TRUNC(SYSDATE) - LEVEL + 1 as base_date
            FROM dual
            CONNECT BY LEVEL &lt;= 7
        ) dates
        LEFT JOIN (
            SELECT TRUNC(o.order_date) as sale_date,
                   SUM(od.item_price * od.item_cnt) as sales
            FROM orders o
            JOIN order_detail od ON o.order_no = od.order_no
            WHERE o.order_status != 'Ï∑®ÏÜå'
            GROUP BY TRUNC(o.order_date)
        ) s ON dates.base_date = s.sale_date
        LEFT JOIN (
            SELECT TRUNC(st.in_date) as stock_date,
                   SUM(st.stock_in * p.origin_p) as expense
            FROM stock st
            JOIN product p ON st.item_no = p.item_no
            WHERE st.stock_in > 0
            GROUP BY TRUNC(st.in_date)
        ) e ON dates.base_date = e.stock_date
        ORDER BY base_date
    </select>

    <!-- ÏàòÏûÖ/ÏßÄÏ∂ú (ÏµúÍ∑º 7Ïùº) -->
    <select id="getIncomeExpense" resultType="map">
        SELECT 
            TO_CHAR(base_date, 'MM-DD') as label,
            NVL(income, 0) as income,
            NVL(expense, 0) as expense
        FROM (
            SELECT TRUNC(SYSDATE) - LEVEL + 1 as base_date
            FROM dual
            CONNECT BY LEVEL &lt;= 7
        ) dates
        LEFT JOIN (
            SELECT TRUNC(o.order_date) as sale_date,
                   SUM(od.item_price * od.item_cnt) as income
            FROM orders o
            JOIN order_detail od ON o.order_no = od.order_no
            WHERE o.order_status != 'Ï∑®ÏÜå'
            GROUP BY TRUNC(o.order_date)
        ) sales ON dates.base_date = sales.sale_date
        LEFT JOIN (
            SELECT TRUNC(s.in_date) as stock_date,
                   SUM(s.stock_in * p.origin_p) as expense
            FROM stock s
            JOIN product p ON s.item_no = p.item_no
            WHERE s.stock_in > 0
            GROUP BY TRUNC(s.in_date)
        ) stocks ON dates.base_date = stocks.stock_date
        ORDER BY base_date
    </select>

</mapper>