<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dashboardmapper">

    <!-- 대시보드 요약 (카드 4개) -->
    <select id="getSummary" resultType="map">
        SELECT
            -- 신규 회원수 (오늘 가입)
            (SELECT COUNT(*) FROM customer 
             WHERE TRUNC(TO_DATE(reg_date, 'YYYY-MM-DD')) = TRUNC(SYSDATE)) as new_members,
            
            -- 오늘 주문건수
            (SELECT COUNT(*) FROM orders 
             WHERE TRUNC(order_date) = TRUNC(SYSDATE) 
             AND order_status != '취소') as today_orders,
            
            -- 오늘 매출
            (SELECT NVL(SUM(od.item_price * od.item_cnt), 0) 
             FROM orders o
             JOIN order_detail od ON o.order_no = od.order_no
             WHERE TRUNC(o.order_date) = TRUNC(SYSDATE)
             AND o.order_status != '취소') as today_sales,
            
            -- 이번달 매출
            (SELECT NVL(SUM(od.item_price * od.item_cnt), 0)
             FROM orders o
             JOIN order_detail od ON o.order_no = od.order_no
             WHERE TO_CHAR(o.order_date, 'YYYY-MM') = TO_CHAR(SYSDATE, 'YYYY-MM')
             AND o.order_status != '취소') as month_sales,
            
            -- 총 주문건수
            (SELECT COUNT(*) FROM orders WHERE order_status != '취소') as total_orders,
            
            -- 총 매출
            (SELECT NVL(SUM(od.item_price * od.item_cnt), 0)
             FROM orders o
             JOIN order_detail od ON o.order_no = od.order_no
             WHERE o.order_status != '취소') as total_sales
        FROM dual
    </select>

    <!-- 주문 전체 (매일 자정 자동 초기화) -->
	<!-- 날짜별 주문 조회 -->
	<select id="getRecentOrders" resultType="map" parameterType="String">
	    SELECT
	        o.order_no,
	        o.order_name as customer_name,
	        p.item_name,
	        od.item_cnt as qty,
	        (od.item_price * od.item_cnt) as amount,
	        TO_CHAR(o.order_date, 'MM-DD HH24:MI') as order_date
	    FROM orders o
	    JOIN order_detail od ON o.order_no = od.order_no
	    JOIN product p ON od.item_no = p.item_no
	    WHERE o.order_status != '취소'
	      AND TRUNC(o.order_date) = 
	        <choose>
	            <when test="_parameter != null and _parameter != ''">
	                TO_DATE(#{_parameter}, 'YYYY-MM-DD')
	            </when>
	            <otherwise>
	                TRUNC(SYSDATE)
	            </otherwise>
	        </choose>
	    ORDER BY o.order_date DESC
	</select>
    <!-- 일별 매출 (최근 7일) -->
    <select id="getDailySales" resultType="map">
        SELECT 
            TO_CHAR(base_date, 'MM-DD') as label,
            NVL(sales, 0) as sales,
            NVL(expense, 0) as expense
        FROM (
            SELECT TRUNC(SYSDATE) - LEVEL + 1 as base_date
            FROM dual
            CONNECT BY LEVEL &lt;= 7
        ) dates
        LEFT JOIN (
            SELECT TRUNC(o.order_date) as sale_date,
                   SUM(od.item_price * od.item_cnt) as sales
            FROM orders o
            JOIN order_detail od ON o.order_no = od.order_no
            WHERE o.order_status != '취소'
            GROUP BY TRUNC(o.order_date)
        ) s ON dates.base_date = s.sale_date
        LEFT JOIN (
            SELECT TRUNC(st.in_date) as stock_date,
                   SUM(st.stock_in * p.origin_p) as expense
            FROM stock st
            JOIN product p ON st.item_no = p.item_no
            WHERE st.stock_in > 0
            GROUP BY TRUNC(st.in_date)
        ) e ON dates.base_date = e.stock_date
        ORDER BY base_date
    </select>

    <!-- 수입/지출 (최근 7일) -->
    <select id="getIncomeExpense" resultType="map">
        SELECT 
            TO_CHAR(base_date, 'MM-DD') as label,
            NVL(income, 0) as income,
            NVL(expense, 0) as expense
        FROM (
            SELECT TRUNC(SYSDATE) - LEVEL + 1 as base_date
            FROM dual
            CONNECT BY LEVEL &lt;= 7
        ) dates
        LEFT JOIN (
            SELECT TRUNC(o.order_date) as sale_date,
                   SUM(od.item_price * od.item_cnt) as income
            FROM orders o
            JOIN order_detail od ON o.order_no = od.order_no
            WHERE o.order_status != '취소'
            GROUP BY TRUNC(o.order_date)
        ) sales ON dates.base_date = sales.sale_date
        LEFT JOIN (
            SELECT TRUNC(s.in_date) as stock_date,
                   SUM(s.stock_in * p.origin_p) as expense
            FROM stock s
            JOIN product p ON s.item_no = p.item_no
            WHERE s.stock_in > 0
            GROUP BY TRUNC(s.in_date)
        ) stocks ON dates.base_date = stocks.stock_date
        ORDER BY base_date
    </select>

</mapper>