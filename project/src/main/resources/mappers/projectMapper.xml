<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace = "projectMapper">
	<select id="selectProductById" parameterType="int" resultType="ProductVO">
		SELECT
			item_no      AS item_no,
			item_img     AS item_img,
			item_name    AS item_name,
			item_content AS item_content,
			origin_p     AS origin_p,
			sales_p      AS sales_p,
			stock_cnt    AS stock_cnt,
			cate_no      AS cate_no,
			dis_rate     AS dis_rate
		FROM product
		WHERE item_no = #{item_no}
	</select>
    
	<select id="selectAllProducts" resultType="ProductVO">
		SELECT
			item_no      AS item_no,
			item_img     AS item_img,
			item_name    AS item_name,
			item_content AS item_content,
			origin_p     AS origin_p,
			sales_p      AS sales_p,
			stock_cnt    AS stock_cnt,
			cate_no      AS cate_no,
			dis_rate     AS dis_rate
		FROM product
		ORDER BY item_no DESC
	</select>

	<select id="selectProducts" parameterType="map" resultType="ProductVO">
		SELECT * FROM (
			SELECT a.*, ROWNUM rn FROM (
				SELECT
					p.item_no      AS item_no,
					p.item_img     AS item_img,
					p.item_name    AS item_name,
					p.item_content AS item_content,
					p.origin_p     AS origin_p,
					p.sales_p      AS sales_p,
					p.stock_cnt    AS stock_cnt,
					p.cate_no      AS cate_no,
					p.dis_rate     AS dis_rate,
					(SELECT AVG(rating) FROM review WHERE item_no = p.item_no) AS avg_rating,
					(SELECT COUNT(*) FROM review WHERE item_no = p.item_no) AS review_cnt
				FROM product p
				<where>
					<if test="q != null and q != ''">
						(p.item_name LIKE '%' || #{q} || '%' OR p.item_content LIKE '%' || #{q} || '%')
					</if>
					<if test="cate_no != null">
						AND p.cate_no = #{cate_no}
					</if>
				</where>
				<choose>
					<when test="sort == 'price_asc'">ORDER BY p.sales_p ASC</when>
					<when test="sort == 'price_desc'">ORDER BY p.sales_p DESC</when>
					<otherwise>ORDER BY p.item_no DESC</otherwise>
				</choose>
			) a WHERE ROWNUM &lt;= #{offset} + #{size}
		)
		WHERE rn &gt; #{offset}
	</select>

	<select id="selectProductsCount" parameterType="map" resultType="int">
		SELECT COUNT(*) FROM product
		<where>
			<if test="q != null and q != ''">
				(item_name LIKE '%' || #{q} || '%' OR item_content LIKE '%' || #{q} || '%')
			</if>
			<if test="cate_no != null">
				AND cate_no = #{cate_no}
			</if>
		</where>
	</select>

<!-- 랜덤 상품 4개 추천 (bx slider용) -->
	<select id="selectRandomProducts" parameterType="int" resultType="productVO">
		SELECT * FROM (
			SELECT
				item_no      AS item_no,
				item_img     AS item_img,
				item_name    AS item_name,
				item_content AS item_content,
				origin_p     AS origin_p,
				sales_p      AS sales_p,
				stock_cnt    AS stock_cnt,
				cate_no      AS cate_no,
				dis_rate     AS dis_rate
			FROM product
			ORDER BY DBMS_RANDOM.VALUE
		) WHERE ROWNUM &lt;= #{limit}
	</select>

	<select id="selectDiscount" resultType="com.example.model.vo.ProductVO">
	SELECT  *
	FROM product 
	WHERE dis_rate IS NOT NULL AND dis_rate > 0
	
	</select>
	
	<select id="newarrivals" parameterType="map" resultType="com.example.model.vo.ProductVO">
	SELECT *
	FROM product
	ORDER BY CREATED_AT DESC
	</select>
	
	<select id="selectNewArrivalsCount" resultType="int">
    SELECT COUNT(*)
    FROM product
    ORDER BY created_at DESC
</select>
</mapper>
</mapper>

